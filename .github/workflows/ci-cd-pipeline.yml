name: GCP CI/CD Pipeline with Security Gate

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: '3.11'
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: us-central1
  SERVICE_NAME: snyk-gemini-demo

jobs:
  # Job 1: Code Quality
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install linting tools
        run: |
          pip install flake8 black
      
      - name: Run flake8
        run: flake8 src/ --max-line-length=100
      
      - name: Check code formatting
        run: black --check src/

  # Job 2: Snyk Security Scanning âœ… ADDED
  security-scan:
    name: Snyk Security Gate
    runs-on: ubuntu-latest
    needs: [lint]
    permissions:
      contents: read
      security-events: write
      actions: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # Snyk Open Source - Check dependencies
      - name: Run Snyk Open Source Test
        uses: snyk/actions/python-3.11@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test
          args: --severity-threshold=high --json-file-output=snyk-opensource.json
      
      # Snyk Code - SAST scan
      - name: Run Snyk Code Test
        uses: snyk/actions/python-3.11@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: code test
          args: --severity-threshold=high --json-file-output=snyk-code.json
      
      # Upload to GitHub Security tab
      - name: Upload Snyk results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: snyk.sarif
      
      - name: Upload Snyk reports as artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: snyk-reports
          path: |
            snyk-*.json
            snyk.sarif
      
      # Security Gate - Block deployment if critical issues found
      - name: Check for Critical Vulnerabilities
        if: always()
        run: |
          echo "ðŸ” Analyzing Snyk results..."
          
          if [ -f snyk-code.json ]; then
            CRITICAL_COUNT=$(jq -r '.runs[0].results | map(select(.level == "error")) | length' snyk-code.json 2>/dev/null || echo "0")
            echo "Critical vulnerabilities in code: $CRITICAL_COUNT"
            
            if [ "$CRITICAL_COUNT" -gt 0 ]; then
              echo "âŒ SECURITY GATE FAILED: $CRITICAL_COUNT critical vulnerabilities found"
              echo "Review findings in GitHub Security tab"
              exit 1
            fi
          fi
          
          if [ -f snyk-opensource.json ]; then
            HIGH_VULN=$(jq -r '.vulnerabilities | map(select(.severity == "critical" or .severity == "high")) | length' snyk-opensource.json 2>/dev/null || echo "0")
            echo "High/Critical vulnerabilities in dependencies: $HIGH_VULN"
            
            if [ "$HIGH_VULN" -gt 5 ]; then
              echo "âš ï¸  WARNING: $HIGH_VULN high/critical vulnerabilities in dependencies"
              echo "Consider updating dependencies before deploying"
              # Uncomment to block deployment:
              # exit 1
            fi
          fi
          
          echo "âœ… Security gate passed"

  # Job 3: Build Container Image
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [security-scan]  # âœ… Build only after security scan passes
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Configure Docker for GCR
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev
      
      - name: Build Docker image
        run: |
          IMAGE_TAG=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/snyk-demo/${{ env.SERVICE_NAME }}:${{ github.sha }}
          IMAGE_LATEST=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/snyk-demo/${{ env.SERVICE_NAME }}:latest
          
          docker build -t $IMAGE_TAG -t $IMAGE_LATEST .
          
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "$IMAGE_TAG" > image-tag.txt
      
      # âœ… Snyk Container Scan - Check Docker image
      - name: Run Snyk Container Test
        uses: snyk/actions/docker@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: ${{ env.IMAGE_TAG }}
          args: --severity-threshold=high --json-file-output=snyk-container.json
      
      - name: Check Container Security
        if: always()
        run: |
          if [ -f snyk-container.json ]; then
            CRITICAL_CONTAINER=$(jq -r '.vulnerabilities | map(select(.severity == "critical")) | length' snyk-container.json 2>/dev/null || echo "0")
            echo "Critical vulnerabilities in container: $CRITICAL_CONTAINER"
            
            if [ "$CRITICAL_CONTAINER" -gt 0 ]; then
              echo "âš ï¸  WARNING: $CRITICAL_CONTAINER critical vulnerabilities in container image"
              echo "Review base image and dependencies"
              # Uncomment to block deployment:
              # exit 1
            fi
          fi
          
          echo "âœ… Container security check passed"
      
      - name: Push Docker image to Artifact Registry
        run: |
          IMAGE_TAG=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/snyk-demo/${{ env.SERVICE_NAME }}:${{ github.sha }}
          IMAGE_LATEST=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/snyk-demo/${{ env.SERVICE_NAME }}:latest
          
          docker push $IMAGE_TAG
          docker push $IMAGE_LATEST
      
      - name: Upload image tag artifact
        uses: actions/upload-artifact@v4
        with:
          name: image-tag
          path: image-tag.txt
      
      - name: Upload container scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: snyk-container-report
          path: snyk-container.json

  # Job 4: Deploy to Cloud Run (Staging)
  deploy-staging:
    name: Deploy to Cloud Run Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop'
    permissions:
      contents: read
      id-token: write
    environment:
      name: staging
      url: ${{ steps.deploy.outputs.url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download image tag
        uses: actions/download-artifact@v4
        with:
          name: image-tag
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
      
      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_NAME }}-staging
          region: ${{ env.GCP_REGION }}
          image: $(cat image-tag.txt)
          env_vars: |
            FLASK_ENV=staging
          secrets: |
            SECRET_KEY=SECRET_KEY:latest
            JWT_SECRET=JWT_SECRET:latest
            API_KEY=API_KEY:latest
          flags: |
            --allow-unauthenticated
            --memory=512Mi
            --cpu=1
            --max-instances=10
            --min-instances=0
      
      - name: Show deployment URL
        run: |
          echo "ðŸš€ Staging deployed to: ${{ steps.deploy.outputs.url }}"
      
      - name: Run smoke tests
        run: |
          echo "Running smoke tests against staging..."
          STAGING_URL="${{ steps.deploy.outputs.url }}"
          
          # Health check
          curl -f "$STAGING_URL/health" || exit 1
          echo "âœ… Health check passed"
      
      # âœ… Snyk Monitor - Send snapshot to Snyk for continuous monitoring
      - name: Snyk Monitor Staging
        uses: snyk/actions/python-3.11@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: monitor
          args: --project-name=snyk-gemini-demo-staging

  # Job 5: Deploy to Cloud Run (Production)
  deploy-production:
    name: Deploy to Cloud Run Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      id-token: write
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download image tag
        uses: actions/download-artifact@v4
        with:
          name: image-tag
      
      - name: Download Snyk reports
        uses: actions/download-artifact@v4
        with:
          name: snyk-reports
          path: ./snyk-reports
      
      # Final security verification before production
      - name: Final Security Check
        run: |
          echo "ðŸ”’ Final security verification before production deployment..."
          
          # Check if any critical issues exist
          if [ -f ./snyk-reports/snyk-code.json ]; then
            ISSUES=$(jq -r '.runs[0].results | length' ./snyk-reports/snyk-code.json 2>/dev/null || echo "0")
            echo "Code issues found: $ISSUES"
          fi
          
          echo "âœ… Final security check completed"
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
      
      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_NAME }}-production
          region: ${{ env.GCP_REGION }}
          image: $(cat image-tag.txt)
          env_vars: |
            FLASK_ENV=production
          secrets: |
            SECRET_KEY=SECRET_KEY:latest
            JWT_SECRET=JWT_SECRET:latest
            API_KEY=API_KEY:latest
            DB_PASSWORD=DB_PASSWORD:latest
          flags: |
            --allow-unauthenticated
            --memory=1Gi
            --cpu=2
            --max-instances=100
            --min-instances=1
            --cpu-throttling
      
      - name: Show deployment URL
        run: |
          echo "ðŸš€ Production deployed to: ${{ steps.deploy.outputs.url }}"
      
      - name: Run smoke tests
        run: |
          echo "Running smoke tests against production..."
          PROD_URL="${{ steps.deploy.outputs.url }}"
          
          # Health check
          curl -f "$PROD_URL/health" || exit 1
          echo "âœ… Health check passed"
          
          # Basic API test
          curl -f "$PROD_URL/api/user/1" || exit 1
          echo "âœ… API test passed"
      
      # âœ… Snyk Monitor - Send production snapshot to Snyk
      - name: Snyk Monitor Production
        uses: snyk/actions/python-3.11@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: monitor
          args: --project-name=snyk-gemini-demo-production

  # Job 6: Security Report Summary
  security-summary:
    name: Security Report Summary
    runs-on: ubuntu-latest
    needs: [security-scan, build]
    if: always()
    
    steps:
      - name: Download all Snyk reports
        uses: actions/download-artifact@v4
        with:
          pattern: snyk-*
          merge-multiple: true
      
      - name: Generate Security Summary
        run: |
          echo "# ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Code Analysis
          if [ -f snyk-code.json ]; then
            echo "## Snyk Code (SAST)" >> $GITHUB_STEP_SUMMARY
            CRITICAL=$(jq -r '.runs[0].results | map(select(.level == "error")) | length' snyk-code.json 2>/dev/null || echo "0")
            WARNING=$(jq -r '.runs[0].results | map(select(.level == "warning")) | length' snyk-code.json 2>/dev/null || echo "0")
            echo "- Critical Issues: $CRITICAL" >> $GITHUB_STEP_SUMMARY
            echo "- Warnings: $WARNING" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Dependency Analysis
          if [ -f snyk-opensource.json ]; then
            echo "## Snyk Open Source" >> $GITHUB_STEP_SUMMARY
            CRITICAL=$(jq -r '.vulnerabilities | map(select(.severity == "critical")) | length' snyk-opensource.json 2>/dev/null || echo "0")
            HIGH=$(jq -r '.vulnerabilities | map(select(.severity == "high")) | length' snyk-opensource.json 2>/dev/null || echo "0")
            echo "- Critical Vulnerabilities: $CRITICAL" >> $GITHUB_STEP_SUMMARY
            echo "- High Vulnerabilities: $HIGH" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Container Analysis
          if [ -f snyk-container.json ]; then
            echo "## Snyk Container" >> $GITHUB_STEP_SUMMARY
            CRITICAL=$(jq -r '.vulnerabilities | map(select(.severity == "critical")) | length' snyk-container.json 2>/dev/null || echo "0")
            HIGH=$(jq -r '.vulnerabilities | map(select(.severity == "high")) | length' snyk-container.json 2>/dev/null || echo "0")
            echo "- Critical Vulnerabilities: $CRITICAL" >> $GITHUB_STEP_SUMMARY
            echo "- High Vulnerabilities: $HIGH" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š View detailed reports in [GitHub Security tab](https://github.com/${{ github.repository }}/security/code-scanning)" >> $GITHUB_STEP_SUMMARY
          secrets: |
            SECRET_KEY=SECRET_KEY:latest
            JWT_SECRET=JWT_SECRET:latest
            API_KEY=API_KEY:latest
            DB_PASSWORD=DB_PASSWORD:latest
          flags: |
            --allow-unauthenticated
            --memory=1Gi
            --cpu=2
            --max-instances=100
            --min-instances=1
            --cpu-throttling
      
      - name: Show deployment URL
        run: |
          echo "ðŸš€ Production deployed to: ${{ steps.deploy.outputs.url }}"
      
      - name: Run smoke tests
        run: |
          echo "Running smoke tests against production..."
          PROD_URL="${{ steps.deploy.outputs.url }}"
          
          # Health check
          curl -f "$PROD_URL/health" || exit 1
          echo "âœ… Health check passed"
          
          # Basic API test
          curl -f "$PROD_URL/api/user/1" || exit 1
          echo "âœ… API test passed"
      
      # âœ… Snyk Monitor - Send production snapshot to Snyk
      - name: Snyk Monitor Production
        uses: snyk/actions/python-3.11@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: monitor
          args: --project-name=snyk-gemini-demo-production

  # Job 7: Security Report Summary
  security-summary:
    name: Security Report Summary
    runs-on: ubuntu-latest
    needs: [security-scan, build]
    if: always()
    
    steps:
      - name: Download all Snyk reports
        uses: actions/download-artifact@v4
        with:
          pattern: snyk-*
          merge-multiple: true
      
      - name: Generate Security Summary
        run: |
          echo "# ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Code Analysis
          if [ -f snyk-code.json ]; then
            echo "## Snyk Code (SAST)" >> $GITHUB_STEP_SUMMARY
            CRITICAL=$(jq -r '.runs[0].results | map(select(.level == "error")) | length' snyk-code.json 2>/dev/null || echo "0")
            WARNING=$(jq -r '.runs[0].results | map(select(.level == "warning")) | length' snyk-code.json 2>/dev/null || echo "0")
            echo "- Critical Issues: $CRITICAL" >> $GITHUB_STEP_SUMMARY
            echo "- Warnings: $WARNING" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Dependency Analysis
          if [ -f snyk-opensource.json ]; then
            echo "## Snyk Open Source" >> $GITHUB_STEP_SUMMARY
            CRITICAL=$(jq -r '.vulnerabilities | map(select(.severity == "critical")) | length' snyk-opensource.json 2>/dev/null || echo "0")
            HIGH=$(jq -r '.vulnerabilities | map(select(.severity == "high")) | length' snyk-opensource.json 2>/dev/null || echo "0")
            echo "- Critical Vulnerabilities: $CRITICAL" >> $GITHUB_STEP_SUMMARY
            echo "- High Vulnerabilities: $HIGH" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Container Analysis
          if [ -f snyk-container.json ]; then
            echo "## Snyk Container" >> $GITHUB_STEP_SUMMARY
            CRITICAL=$(jq -r '.vulnerabilities | map(select(.severity == "critical")) | length' snyk-container.json 2>/dev/null || echo "0")
            HIGH=$(jq -r '.vulnerabilities | map(select(.severity == "high")) | length' snyk-container.json 2>/dev/null || echo "0")
            echo "- Critical Vulnerabilities: $CRITICAL" >> $GITHUB_STEP_SUMMARY
            echo "- High Vulnerabilities: $HIGH" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š View detailed reports in [GitHub Security tab](https://github.com/${{ github.repository }}/security/code-scanning)" >> $GITHUB_STEP_SUMMARY

### Updated CI/CD Pipeline Summary
