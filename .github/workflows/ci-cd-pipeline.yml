name: GCP CI/CD Pipeline with Security Gate

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: '3.11'
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: us-central1
  SERVICE_NAME: snyk-gemini-demo

jobs:
  # Job 1: Code Quality
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install linting tools
        run: |
          pip install flake8 black
      
      - name: Auto format code with black
        run: black src/
      
      - name: Run flake8
        run: flake8 src/ --max-line-length=100
      
      - name: Check code formatting
        run: black --check src/

  # Job 2: Build Container Image
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [lint]
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Configure Docker for GCR
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev
      
      - name: Build Docker image
        run: |
          IMAGE_TAG=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/gemini-demo/${{ env.SERVICE_NAME }}:${{ github.sha }}
          IMAGE_LATEST=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/gemini-demo/${{ env.SERVICE_NAME }}:latest
          
          docker build -t $IMAGE_TAG -t $IMAGE_LATEST .
          
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "$IMAGE_TAG" > image-tag.txt
      
      # ‚úÖ Snyk Container Scan - Check Docker image
      - name: Run Snyk Container Test
        uses: snyk/actions/docker@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: ${{ env.IMAGE_TAG }}
          args: --severity-threshold=high --json-file-output=snyk-container.json
      
      - name: Check Container Security
        if: always()
        run: |
          if [ -f snyk-container.json ]; then
            CRITICAL_CONTAINER=$(jq -r '.vulnerabilities | map(select(.severity == "critical")) | length' snyk-container.json 2>/dev/null || echo "0")
            echo "Critical vulnerabilities in container: $CRITICAL_CONTAINER"
            
            if [ "$CRITICAL_CONTAINER" -gt 0 ]; then
              echo "‚ö†Ô∏è  WARNING: $CRITICAL_CONTAINER critical vulnerabilities in container image"
              echo "Review base image and dependencies"
              # Uncomment to block deployment:
              # exit 1
            fi
          fi
          
          echo "‚úÖ Container security check passed"
      
      - name: Push Docker image to Artifact Registry
        run: |
          IMAGE_TAG=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/gemini-demo/${{ env.SERVICE_NAME }}:${{ github.sha }}
          IMAGE_LATEST=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/gemini-demo/${{ env.SERVICE_NAME }}:latest
          
          docker push $IMAGE_TAG
          docker push $IMAGE_LATEST
      
      - name: Upload image tag artifact
        uses: actions/upload-artifact@v4
        with:
          name: image-tag
          path: image-tag.txt
      
      - name: Upload container scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: snyk-container-report
          path: snyk-container.json

# Job 4: Deploy to Cloud Run (Production)
  deploy-production:
    name: Deploy to Cloud Run Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      id-token: write
    environment:
      name: production
      url: ${{ steps.resolve-production.outputs.service_url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download image tag
        uses: actions/download-artifact@v4
        with:
          name: image-tag
      
      - name: Read image tag
        id: image
        run: |
          IMAGE_TAG=$(cat image-tag.txt)
          echo "tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "Image to deploy: $IMAGE_TAG"

      - name: Authenticate to Google Cloud (Workload Identity Federation)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
      
      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_NAME }}-production
          region: ${{ env.GCP_REGION }}
          image: ${{ steps.image.outputs.tag }}
          env_vars: |
            FLASK_ENV=production
          secrets: |
            SECRET_KEY=SECRET_KEY:latest
            JWT_SECRET=JWT_SECRET:latest
            API_KEY=API_KEY:latest
            DB_PASSWORD=DB_PASSWORD:latest
          flags: |
            --allow-unauthenticated
            --memory=1Gi
            --cpu=2
            --max-instances=100
            --min-instances=1
            --cpu-throttling

      - name: Resolve Cloud Run Production URL
        id: resolve-production
        run: |
          echo "Resolving Cloud Run service URL..."
          SERVICE_NAME="${{ env.SERVICE_NAME }}-production"
          gcloud config set project ${{ env.GCP_PROJECT_ID }}
          gcloud config set run/region ${{ env.GCP_REGION }}
          gcloud run services describe "$SERVICE_NAME" \
            --region="${{ env.GCP_REGION }}" \
            --format='value(status.url)' > service_url.txt
          SERVICE_URL=$(cat service_url.txt)
          echo "service_url=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "‚úÖ Resolved Cloud Run Production URL: $SERVICE_URL"

      - name: Health Check (Production)
        run: |
          echo "Checking health endpoint..."
          curl -fsSL "${{ steps.resolve-production.outputs.service_url }}/health" || exit 1

      - name: Show deployment URL
        run: |
          echo "üöÄ Production deployed successfully!"
          echo "üåê URL: ${{ steps.resolve-production.outputs.service_url }}/health"
          
      - name: Run smoke tests
        run: |
          echo "Running smoke tests against production..."
          PROD_URL="${{ steps.deploy.outputs.url }}"
          
          # Health check
          curl -f "$PROD_URL/health" || exit 1
          echo "‚úÖ Health check passed"
          
          # Basic API test
          curl -f "$PROD_URL/api/user/1" || exit 1
          echo "‚úÖ API test passed"
      
      # ‚úÖ Snyk Monitor - Send production snapshot to Snyk
      - name: Snyk Monitor Production
        uses: snyk/actions/python-3.11@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: monitor
          args: --project-name=snyk-gemini-demo-production
